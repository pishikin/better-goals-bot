// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// IMPORTANT: Prisma resolves relative DATABASE_URL paths from THIS FILE's location!
// For production, always use ABSOLUTE path in .env:
//   DATABASE_URL="file:/var/app/goals-bot/data/app.db"
// NOT relative path like "file:./data/app.db" which would resolve to prisma/data/app.db
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(cuid())
  telegramId            BigInt   @unique @map("telegram_id")
  language              String   @default("en")
  timezone              String   @default("UTC")
  // New daily planning model settings
  morningPlanTime       String?  @default("09:00") @map("morning_plan_time")
  eveningReviewTime     String?  @default("21:00") @map("evening_review_time")
  dailyRemindersCount   Int      @default(1) @map("daily_reminders_count")
  // JSON array of HH:mm, 1-3 items
  dailyRemindersTimes   String?  @default("[\"14:00\"]") @map("daily_reminders_times")
  // Optional advanced mode: allow linking tasks to areas
  taskAreaLinkingEnabled Boolean @default(false) @map("task_area_linking_enabled")
  // One-time onboarding notice after migration to the new model
  newModelOnboardingShownAt DateTime? @map("new_model_onboarding_shown_at")
  // Digest reminder times (JSON array as string, e.g., '["09:00","14:00"]')
  // 1-3 times allowed, always sends
  digestTimes           String?  @map("digest_times")
  // Progress reminder time (single HH:mm), only sends if no progress today
  progressReminderTime  String?  @map("progress_reminder_time")
  pinnedMessageId       BigInt?  @map("pinned_message_id")
  onboardingCompleted   Boolean  @default(false) @map("onboarding_completed")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  areas           Area[]
  progressEntries ProgressEntry[]
  dailyPlans      DailyPlan[]
  tasks           Task[]

  @@map("users")
}

model Area {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String // max 50 chars (validate in code)
  body      String? // max 200 chars (validate in code)
  emoji     String?
  archived  Boolean @default(false)
  position  Int // creation order, no reorder in MVP
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  progressEntries ProgressEntry[]
  tasks           Task[]

  @@map("areas")
}

model ProgressEntry {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Nullable: null means this is a check-in entry (user skipped all areas)
  areaId    String?  @map("area_id")
  area      Area?    @relation(fields: [areaId], references: [id], onDelete: Cascade)
  // Nullable: null for check-in entries
  content   String?
  // True if user skipped this area (or all areas for check-in)
  skipped   Boolean  @default(false)
  date      DateTime @map("date")
  createdAt DateTime @default(now()) @map("created_at")

  // For regular entries: unique per user+area+date
  // For check-in entries (areaId=null): only one per user+date (enforced in code)
  @@unique([userId, areaId, date])
  @@map("progress_entries")
}

model DailyPlan {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date             DateTime
  // draft | confirmed | review_pending | reviewed
  status           String   @default("draft")
  // manual | scheduled | carryover
  source           String?
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  confirmedAt      DateTime? @map("confirmed_at")
  reviewStartedAt  DateTime? @map("review_started_at")
  reviewCompletedAt DateTime? @map("review_completed_at")

  tasks Task[]

  @@unique([userId, date])
  @@index([userId, date])
  @@map("daily_plans")
}

model Task {
  id             String    @id @default(cuid())
  planId         String    @map("plan_id")
  plan           DailyPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  userId         String    @map("user_id")
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  areaId         String?   @map("area_id")
  area           Area?     @relation(fields: [areaId], references: [id], onDelete: SetNull)
  text           String
  position       Int
  // pending | done | in_progress | skipped
  status         String    @default("pending")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  statusUpdatedAt DateTime? @map("status_updated_at")
  carriedFromTaskId String? @map("carried_from_task_id")
  carriedFromTask   Task?    @relation("TaskCarryOver", fields: [carriedFromTaskId], references: [id], onDelete: SetNull)
  carriedToTasks    Task[]   @relation("TaskCarryOver")

  @@unique([planId, position])
  @@index([userId, status])
  @@index([planId, position])
  @@map("tasks")
}
